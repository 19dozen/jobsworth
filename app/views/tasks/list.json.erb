{"tasks": {
"records":"<%= @tasks.size %>",
"rows": [
<%  total_time = 0
    @tasks.each_with_index do |task, idx|
    cache([ task, current_user.id ]) do
      customer = (task.customers.first || task.project.customer)
-%>
{
<%    readFlag = ""
      total_time += task.minutes_left.to_i
      if (task.unread?(current_user))
        readFlag = "f" # this task is unread
      else if (task.users + task.watchers).include?(current_user) # only users assigned to or watching a task can mark unread
        readFlag = "t" # this task is read and can be switched to unread
      else
        readFlag = "x" # this task doesn't have the current user assigned/cc
      end
    end
-%>
"read":<%= readFlag.to_json.html_safe %>,
"id":<%= task.task_num.to_json.html_safe %>,
<%  current_user.company.properties.each do |prop| -%>
<%= prop.name.downcase.to_json.html_safe %>:<%= task.property_value(prop).to_html.to_json.html_safe rescue "\"\"".html_safe %>,
<%  end -%>
"summary":<%= task.name.to_json.html_safe %>,
"client":<%= customer.name.to_json.html_safe %>,
<% str = [ task.project.name ] -%>
<% str << task.milestone.name if task.milestone_id.to_i > 0 -%>
"milestone":<%= str.join("/").to_json.html_safe %>,
"due":<%= task.due_date.to_time.to_i.to_json.html_safe rescue "\"\"".html_safe %>,
"time":<%= task.minutes_left.to_i.to_json.html_safe rescue "\"\"".html_safe %>,
"assigned":<%= task.owners.map{ |u| u.name }.join(", ").to_json.html_safe %>,
"resolution":<%= task.status_type.to_json.html_safe %>
}<%= "," unless @tasks.size - 1 == idx  %>
    <% end -%>
    <% end -%>
],
"userdata":{"time":<%= total_time.to_json.html_safe %>}
  }
}